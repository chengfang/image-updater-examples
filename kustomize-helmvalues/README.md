This example contains a helm-based multi-source app:
* source 1: kustomize source
* source 2: nginx chart from helm repository
* source 3:
  - `values.yaml`: an empty custom values file to serve as the write-back-target for image updater.
      After image updater run, this file will be populated with changes. To reproduce this use case
      in subsequent image updater runs, all content of this file should be removed.
  - `values-0.yaml`: the values file used by this application manifest to use an old image version.
      Note that this file should not be modified by image updater runs.

This sample verifies that image updater should be able to correctly identify helm type as the main
application source type, and operate on the corresponding helm source. Kustomize source should not
be updated during image updater run.

After running image-updater, the image version in the live cluster should be updated to the new version.
The changes are written to `kustomize-helmvalues/source2/values.yaml` file.
```yaml
# auto generated by argocd image updater

image:
  tag: 1.27.5
  repository: docker.io/bitnamilegacy/nginx
```

## ImageUpdater Custom Resource Configuration

This sample uses the ImageUpdater Custom Resource (CR) introduced in v1.0.0, instead of the legacy
annotation-based configuration. The ImageUpdater CR is defined in `app/image-updater.yaml`:

```yaml
apiVersion: argocd-image-updater.argoproj.io/v1alpha1
kind: ImageUpdater
metadata:
  name: kustomize-helmvalues
  namespace: argocd
spec:
  namespace: argocd
  applicationRefs:
    - namePattern: "kustomize-helmvalues"
      images:
        - alias: "nginx"
          imageName: "docker.io/bitnamilegacy/nginx:1.27.x"
          commonUpdateSettings:
            updateStrategy: "semver"
            forceUpdate: false
          manifestTargets:
            helm:
              name: "image.repository"
              tag: "image.tag"
  writeBackConfig:
    method: "git:secret:argocd/git-creds"
    gitConfig:
      repository: "https://github.com/chengfang/image-updater-examples.git"
      branch: "main"
      writeBackTarget: "helmvalues:/kustomize-helmvalues/source2/values.yaml"
```

Key fields:
- `applicationRefs.namePattern`: selects the ArgoCD Application by name
- `images.alias`: unique identifier for the image within this CR
- `images.imageName`: the image to track with version constraint
- `manifestTargets.helm.name`: helm values path for image repository
- `manifestTargets.helm.tag`: helm values path for image tag
- `writeBackConfig.method`: "git:secret:argocd/git-creds" specifies git write-back with credentials secret reference
- `writeBackConfig.gitConfig.writeBackTarget`: target file path for writing updates

## test with write-helmvalues
```bash
# to create the secret to access the git repo
kubectl -n argocd create secret generic git-creds --from-literal=username=xxx --from-literal=password=xxx

# to install the kustomize-helmvalues Argo CD application and ImageUpdater CR
kubectl apply -f kustomize-helmvalues/app/kustomize-helmvalues.yaml
kubectl apply -f kustomize-helmvalues/app/image-updater.yaml

# to verify the application state containing both kustomize and helm sources, and 2 images:
kubectl describe -n argocd apps/kustomize-helmvalues
...
  Source Types:
    Kustomize
    Helm

  Summary:
    Images:
      docker.io/bitnamilegacy/nginx:1.27.1
      nginx:1.16.0

# to view the application pod
kubectl get pod kustomize-helmvalues-nginx-xxx -n argocd -o yaml

# to view the current container image name and image tag
kubectl get pod kustomize-helmvalues-nginx-75b44767bb-gtnnd -n argocd -o jsonpath='{.spec.containers[0].image}'
docker.io/bitnami/nginx:1.27.1

# to run image-updater from command line
../image-updater/dist/argocd-image-updater run --once --registries-conf-path=""

# to verify the application state after image updater run:
kubectl describe -n argocd apps/kustomize-helmvalues
...
  Source Types:
    Kustomize
    Helm

  Summary:
    Images:
      docker.io/bitnamilegacy/nginx:1.27.5
      nginx:1.16.0

# to check the updated image tag
kubectl get pod kustomize-helmvalues-nginx-xxx -n argocd -o jsonpath='{.spec.containers[0].image}'
docker.io/bitnami/nginx:1.27.5

# to delete the kustomize-helmvalues app and ImageUpdater CR
kubectl delete -f kustomize-helmvalues/app/image-updater.yaml
kubectl delete -f kustomize-helmvalues/app/kustomize-helmvalues.yaml
```
